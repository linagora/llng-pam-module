# Open Bastion SSH Certificate Authentication Demo
#
# Architecture:
#   - sso: LLNG Portal with SSH CA, PAM Access, Device Authorization
#   - bastion: SSH bastion with session recording
#   - backend: SSH backend with user creation
#   - backend-new: Unconfigured backend for enrollment demo
#
# Usage:
#   docker compose up -d
#   # Test SSO: llng --llng-url http://localhost:80 --login dwho --password dwho llng_cookie
#   # Get SSH cert: docker exec -it bastion ob-ssh-cert -p http://sso
#   # SSH to bastion: ssh -p 2222 dwho@localhost

services:
  sso:
    build:
      context: ./sso
      dockerfile: Dockerfile
    image: ob-cert-sso
    container_name: ob-cert-sso
    ports:
      - "80:8080"
    volumes:
      # Custom plugins (individual files to not override existing plugins)
      - ../llng-plugin/usr/share/perl5/Lemonldap/NG/Portal/Plugins/PamAccess.pm:/usr/share/perl5/Lemonldap/NG/Portal/Plugins/PamAccess.pm:ro
      - ../llng-plugin/usr/share/perl5/Lemonldap/NG/Portal/Plugins/OIDCDeviceAuthorization.pm:/usr/share/perl5/Lemonldap/NG/Portal/Plugins/OIDCDeviceAuthorization.pm:ro
      - ../llng-plugin/usr/share/perl5/Lemonldap/NG/Portal/Plugins/SSHCA.pm:/usr/share/perl5/Lemonldap/NG/Portal/Plugins/SSHCA.pm:ro
      # Templates for PAM Access and Device Authorization
      - ../llng-plugin/usr/share/lemonldap-ng/portal/templates/bootstrap/pamaccess.tpl:/usr/share/lemonldap-ng/portal/templates/bootstrap/pamaccess.tpl:ro
      - ../llng-plugin/usr/share/lemonldap-ng/portal/templates/bootstrap/device.tpl:/usr/share/lemonldap-ng/portal/templates/bootstrap/device.tpl:ro
      - ../llng-plugin/usr/share/lemonldap-ng/portal/templates/bootstrap/sshca.tpl:/usr/share/lemonldap-ng/portal/templates/bootstrap/sshca.tpl:ro
      # JavaScript for PAM Access
      - ../llng-plugin/usr/share/lemonldap-ng/portal/htdocs/static/common/js/pamaccess.js:/usr/share/lemonldap-ng/portal/htdocs/static/common/js/pamaccess.js:ro
      - ../llng-plugin/usr/share/lemonldap-ng/portal/htdocs/static/common/js/sshca.js:/usr/share/lemonldap-ng/portal/htdocs/static/common/js/sshca.js:ro
      # Configuration
      - ./lmConf-1.json:/var/lib/lemonldap-ng/conf/lmConf-1.json:ro
      # No persistent volumes - fresh start for each demo
    environment:
      - SSODOMAIN=example.com
      - PORTAL=http://localhost
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      ob-cert-net:
        aliases:
          - sso
          - auth.example.com

  bastion:
    build:
      context: ..
      dockerfile: docker-demo-cert/bastion/Dockerfile
    image: ob-cert-bastion
    container_name: ob-cert-bastion
    ports:
      - "2222:22"
    depends_on:
      sso:
        condition: service_healthy
    environment:
      - LLNG_PORTAL_URL=http://sso:8080
      - LLNG_SERVER_GROUP=bastion
      - LLNG_CLIENT_ID=pam-access
      - LLNG_CLIENT_SECRET=pamsecret
      - LLNG_ADMIN_USER=dwho
      - LLNG_ADMIN_PASSWORD=dwho
    volumes:
      # PAM module sources for build
      - ..:/src/llng-pam-module:ro
      # No persistent volumes - fresh start for each demo
    networks:
      - ob-cert-net

  backend:
    build:
      context: ..
      dockerfile: docker-demo-cert/backend/Dockerfile
    image: ob-cert-backend
    container_name: ob-cert-backend
    # No external port - only accessible via bastion
    expose:
      - "22"
    depends_on:
      sso:
        condition: service_healthy
    environment:
      - LLNG_PORTAL_URL=http://sso:8080
      - LLNG_SERVER_GROUP=backend
      - LLNG_CLIENT_ID=pam-access
      - LLNG_CLIENT_SECRET=pamsecret
      - LLNG_ADMIN_USER=dwho
      - LLNG_ADMIN_PASSWORD=dwho
    volumes:
      # PAM module sources for build
      - ..:/src/llng-pam-module:ro
    networks:
      - ob-cert-net

  # Unconfigured backend for enrollment demo
  backend-new:
    build:
      context: ..
      dockerfile: docker-demo-cert/backend-new/Dockerfile
    image: ob-cert-backend-new
    container_name: ob-cert-backend-new
    expose:
      - "22"
    depends_on:
      sso:
        condition: service_healthy
    environment:
      - LLNG_PORTAL_URL=http://sso:8080
      - LLNG_SERVER_GROUP=backend-new
      # No LLNG_SERVER_TOKEN - must be enrolled manually
    networks:
      - ob-cert-net

networks:
  ob-cert-net:
    driver: bridge
