# Security Architecture

This document describes the security measures implemented in the LemonLDAP::NG PAM module.

## Overview

The PAM module authenticates users against a LemonLDAP::NG portal using a secure token-based protocol. Multiple layers of defense protect against various attack vectors.

## Authentication Flow

```
User -> PAM Module -> LLNG Portal (/pam/verify) -> Response
                   <- Single-use token consumed ->
```

1. User provides a one-time token generated by the LLNG portal
2. PAM module verifies token via `/pam/verify` endpoint
3. Token is consumed (single-use) and cannot be replayed
4. Server returns user attributes and authorization status

## Transport Security

### TLS Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| `min_tls_version` | 13 (TLS 1.3) | Minimum TLS version (12=1.2, 13=1.3) |
| `verify_ssl` | true | Verify server certificate |
| `ca_cert` | system | Custom CA certificate path |
| `cert_pin` | none | Certificate pin (sha256//base64 format) |

**Certificate Pinning**: When configured, the module validates the server's public key against the pinned value, preventing MITM attacks even with compromised CAs.

```ini
# Example configuration
min_tls_version = 13
cert_pin = sha256//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
```

### Request Signing (Optional)

When `request_signing_secret` is configured, requests include:

- `X-Timestamp`: Unix timestamp (server should reject if too old)
- `X-Nonce`: Unique `timestamp_ms-uuid` format (server should reject duplicates)
- `X-Signature-256`: HMAC-SHA256 signature of the request

This provides defense-in-depth against request tampering, even if TLS is somehow compromised.

## Server Authentication

The PAM module authenticates to the LLNG server using:

| Setting | Description |
|---------|-------------|
| `server_token_file` | Path to file containing server bearer token |
| `server_group` | Server group name (default: "default") |

The server token should be stored in a file with restricted permissions (0600) owned by root.

## Token Cache Security

### Encryption at Rest

When `cache_encrypted = true` (default), cached tokens are encrypted using:

- **Algorithm**: AES-256-GCM (authenticated encryption)
- **Key Derivation**: PBKDF2-SHA256 with 100,000 iterations
- **Key Source**: Machine ID (`/etc/machine-id`) + cache username as salt
- **Authentication**: GCM tag prevents tampering

```
File format:
[Magic: LLNGCACHE02][IV: 12 bytes][Tag: 16 bytes][Ciphertext]
```

### Cache Isolation

- Each user's cache is stored in a separate file
- File permissions: 0600 (owner read/write only)
- Directory permissions: 0700

### Cache Invalidation

When `cache_invalidate_on_logout = true` (default):
- User's cache is cleared when their PAM session closes
- Prevents stale tokens from being reused

### Risk-Based TTL

| Service Type | Default TTL |
|--------------|-------------|
| Normal services | 300 seconds |
| High-risk services | 60 seconds |

Configure high-risk services via `high_risk_services` (comma-separated).

## Rate Limiting

Protection against brute-force attacks:

| Setting | Default | Description |
|---------|---------|-------------|
| `rate_limit_enabled` | true | Enable rate limiting |
| `rate_limit_max_attempts` | 5 | Failures before lockout |
| `rate_limit_initial_lockout` | 30s | Initial lockout duration |
| `rate_limit_max_lockout` | 3600s | Maximum lockout duration |
| `rate_limit_backoff_mult` | 2.0 | Exponential backoff multiplier |

Lockout state is stored per-user in `rate_limit_state_dir`.

## Auto-Create User Security

When `create_user_enabled = true`, users can be automatically created on first login.

### Path Validation

All paths are validated before use:

**Shell Validation** (`approved_shells`):
- Must be in approved list (default: common shells like /bin/bash, /bin/zsh)
- Must be absolute path
- No path traversal sequences (.., //)
- No shell metacharacters

**Home Directory Validation** (`approved_home_prefixes`):
- Must start with approved prefix (default: /home, /var/home)
- Same safety checks as shell

**Skeleton Directory Validation**:
- Must be absolute path
- Must be owned by root
- No symlinks in path components
- No dangerous patterns

### UID Generation

- UIDs are generated deterministically from username hash
- Range: 10000-60000 (configurable)
- **Collision handling**: If UID exists, operation fails safely (returns 0)
- No fallback to random UIDs that could cause unpredictable behavior

### NSS Module Security

The NSS module (`libnss_llng.so`) provides user resolution:

- **Buffer overflow protection**: All string copies use bounds-checked `safe_strcpy()`
- **Input validation**: All inputs sanitized before use
- **Fail-safe**: Returns appropriate error codes on any failure

## Audit Logging

When `audit_enabled = true`:

| Setting | Default | Description |
|---------|---------|-------------|
| `audit_log_file` | none | JSON audit log file path |
| `audit_to_syslog` | true | Also emit to syslog |
| `audit_level` | 1 | 0=critical, 1=auth events, 2=all |

Audit events include:
- Authentication attempts (success/failure)
- Authorization decisions
- Rate limit triggers
- User creation events

## Webhook Notifications

For real-time security monitoring:

| Setting | Description |
|---------|-------------|
| `notify_enabled` | Enable webhooks |
| `notify_url` | Webhook endpoint URL |
| `notify_secret` | HMAC secret for webhook signatures |

## Configuration Security

### Secrets Management

| Setting | Default | Description |
|---------|---------|-------------|
| `secrets_encrypted` | true | Encrypt secrets at rest |
| `secrets_use_keyring` | true | Use kernel keyring |
| `secrets_keyring_name` | "pam_llng" | Keyring identifier |

### File Permissions

Recommended permissions:

| File | Permissions | Owner |
|------|-------------|-------|
| `/etc/pam_llng.conf` | 0600 | root |
| Server token file | 0600 | root |
| Cache directory | 0700 | root |
| Rate limit state dir | 0700 | root |

## Threat Mitigations

| Threat | Mitigation |
|--------|------------|
| Token replay | Single-use tokens, cache invalidation |
| MITM attacks | TLS 1.3, certificate pinning |
| Brute force | Rate limiting with exponential backoff |
| Cache tampering | AES-256-GCM authenticated encryption |
| Path injection | Strict path validation, approved lists |
| Buffer overflow | Bounds-checked string operations |
| UID collision | Fail-safe collision detection |
| Request tampering | Optional HMAC request signing with nonces |

## Security Reporting

To report security vulnerabilities, please email security@linagora.com with:

1. Description of the vulnerability
2. Steps to reproduce
3. Potential impact
4. Any suggested fixes

We aim to respond within 48 hours and will coordinate disclosure.
