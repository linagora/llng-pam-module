.TH OB-SSH-PROXY 1 "January 2025" "open-bastion" "User Commands"
.SH NAME
ob-ssh-proxy \- SSH proxy command for bastion-to-backend authentication with LLNG JWT
.SH SYNOPSIS
.B ob-ssh-proxy
[\fIOPTIONS\fR] [\fItarget_host\fR] [\fItarget_port\fR]
.SH DESCRIPTION
.B ob-ssh-proxy
is used on bastion servers to request a signed JWT from LemonLDAP::NG
before connecting to backend servers. The JWT proves to the backend that
the connection comes from an authorized bastion with a valid session.
.PP
The script operates in three modes:
.TP
.B ProxyCommand mode
When called with a target host argument, typically from SSH config.
.TP
.B ForceCommand mode
When SSH_ORIGINAL_COMMAND is set (used as sshd ForceCommand).
.TP
.B Interactive mode
When neither argument nor SSH_ORIGINAL_COMMAND is set, prompts for target.
.SH OPTIONS
.TP
.BR \-c ", " \-\-config " " \fIFILE\fR
Use alternate configuration file (default: /etc/open-bastion/ssh-proxy.conf)
.TP
.BR \-d ", " \-\-debug
Enable debug output to stderr
.TP
.BR \-h ", " \-\-help
Show help message and exit
.TP
.BR \-V ", " \-\-version
Show version and exit
.SH CONFIGURATION
The script reads configuration from \fI/etc/open-bastion/ssh-proxy.conf\fR:
.PP
.nf
# LemonLDAP::NG portal URL (required)
PORTAL_URL="https://auth.example.com"

# Server token file (from ob-enroll)
SERVER_TOKEN_FILE="/etc/open-bastion/token"

# Server group for this bastion
SERVER_GROUP="bastion"

# Target server group for backends
TARGET_GROUP="default"

# HTTP timeout (seconds)
TIMEOUT=10

# Verify SSL certificates
VERIFY_SSL=true

# Additional SSH options
SSH_OPTIONS=""

# Enable debug output
DEBUG=false
.fi
.SH SSH CONFIGURATION
.SS Bastion Configuration (~/.ssh/config or /etc/ssh/ssh_config)
.nf
Host backend-*
    ProxyCommand ob-ssh-proxy %h %p
.fi
.PP
Or as ForceCommand in /etc/ssh/sshd_config:
.nf
Match User *
    ForceCommand /usr/bin/ob-ssh-proxy
.fi
.SS Backend Configuration (/etc/ssh/sshd_config)
The backend must accept the OB_BASTION_JWT environment variable:
.nf
AcceptEnv OB_BASTION_JWT
.fi
.SH PAM CONFIGURATION
On backend servers, configure PAM to verify the bastion JWT by adding
to /etc/open-bastion/openbastion.conf:
.nf
bastion_jwt_required = true
bastion_jwt_issuer = https://auth.example.com
.fi
.SH SECURITY
The bastion JWT provides cryptographic proof that:
.IP \(bu 2
The connection originates from an authorized bastion server
.IP \(bu 2
The bastion has a valid session with LemonLDAP::NG
.IP \(bu 2
The user is authorized to connect to the target backend
.IP \(bu 2
The JWT is signed by LemonLDAP::NG using RS256 and can be verified offline
.PP
This prevents unauthorized SSH access to backends even if an attacker
knows the backend's SSH configuration.
.SH FILES
.TP
.I /etc/open-bastion/ssh-proxy.conf
Main configuration file
.TP
.I /etc/open-bastion/token
Server authentication token (from ob-enroll)
.SH ENVIRONMENT
.TP
.B OB_BASTION_JWT
The JWT is exported via this variable and passed to backends via SendEnv.
.TP
.B SSH_ORIGINAL_COMMAND
Used in ForceCommand mode to determine the target host.
.SH EXIT STATUS
.TP
.B 0
Success
.TP
.B 1
Error (configuration, network, authentication)
.SH EXAMPLES
.SS As ProxyCommand
.nf
# In ~/.ssh/config on the bastion:
Host backend-*
    ProxyCommand ob-ssh-proxy %h %p

# Connect from bastion to backend:
$ ssh backend-web01
.fi
.SS Manual invocation
.nf
$ ob-ssh-proxy backend-web01 22
.fi
.SH SEE ALSO
.BR ob-bastion-setup (8),
.BR ob-backend-setup (8),
.BR ob-enroll (8),
.BR openbastion.conf (5),
.BR ssh_config (5),
.BR sshd_config (5)
.SH COPYRIGHT
Copyright (C) 2025 Linagora.
License: AGPL-3.0
.SH AUTHORS
Xavier Guimard <xguimard@linagora.com>
